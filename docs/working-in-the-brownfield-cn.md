# 棕地开发完全指南

> **强烈推荐：使用 Gemini Web 或 Gemini CLI 进行棕地文档生成！**
>
> Gemini Web 的 100万+ token 上下文窗口或 Gemini CLI（正常运行时）可以一次性分析您的整个代码库或其中的关键部分（显然要在合理范围内）：
>
> - 通过 GitHub URL 上传或在项目文件夹中使用 gemini cli
> - 如果在网页上工作：使用 `npx bmad-method flatten` 将项目扁平化为单个文件，然后将该文件上传到您的网页代理。

## 什么是棕地开发？

棕地开发指的是向现有软件项目添加功能、修复bug或进行现代化改造。与绿地（全新）项目不同，棕地工作需要理解现有代码、尊重约束条件，并确保新更改能够无缝集成而不会破坏现有功能。

## 何时使用 BMad 进行棕地开发

- 向现有应用添加重要的新功能
- 现代化遗留代码库
- 集成新技术或服务
- 重构复杂系统
- 修复需要架构理解的bug
- 记录未文档化的系统

## 何时不使用棕地流程

如果您刚刚使用 BMad 完成 MVP，并希望在 MVP 后继续开发，更容易的方式是与 PM 交谈并要求其与您合作创建一个新的史诗（epic）添加到 PRD 中，将史诗分片，与架构师更新任何架构文档，然后从那里开始。

## 完整的棕地开发工作流程

1. **按照[<ins>用户指南 - 安装</ins>](user-guide.md#installation)步骤在网页中设置您的代理。**
2. **生成整个代码库的'扁平化'单个文件** 运行：```npx bmad-method flatten```

### 选择您的方法

#### 方法 A：PRD 优先（推荐用于添加非常大且复杂的新功能、单个或多个史诗或大规模更改）

**最适用于**：大型代码库、单体仓库或当您确切知道自己想要构建什么时

1. **首先创建 PRD** 来定义需求
2. **基于 PRD 需求仅记录相关区域**
3. **更高效** - 避免记录未使用的代码

#### 方法 B：文档优先（适用于较小项目）

**最适用于**：较小的代码库、未知系统或探索性更改

1. **首先记录整个系统**
2. **在完整上下文中创建 PRD**
3. **更全面** - 捕获所有内容

### 方法 A：PRD 优先工作流程（推荐）

#### 阶段 1：首先定义需求

**在 Gemini Web 中（已上传您的 flattened-codebase.xml）：**

```bash
@pm
*create-brownfield-prd
```

PM 将会：

- **询问您的增强**需求
- **探索代码库**以了解当前状态
- **识别需要记录的受影响区域**
- **创建具有明确范围的专注 PRD**

**关键优势**：PRD 识别您的单体仓库/大型代码库中哪些部分实际需要记录！

#### 阶段 2：专注的文档记录

**仍在 Gemini Web 中，现在带有 PRD 上下文：**

```bash
@architect
*document-project
```

分析师将会：

- **询问您的关注点**（如果未提供 PRD）
- **提供选项**：创建 PRD、提供需求或描述增强内容
- **参考 PRD/描述**以理解范围
- **专注于 PRD 或描述中识别的相关模块**
- **跳过不相关区域**以保持文档精简
- **为所有环境生成一个架构文档**

分析师创建：

- **一个全面的架构文档**，遵循全栈架构模板
- **在一个文件中涵盖所有系统方面**
- **易于复制和保存**为 `docs/project-architecture.md`
- **稍后可以在 IDE 中分片**（如果需要）

例如，如果您说"向用户服务添加支付处理"：

- 仅记录：用户服务、API 端点、数据库模式、支付集成
- 创建仅显示支付相关代码路径的专注源树
- 跳过：管理面板、报告模块、无关的微服务

### 方法 B：文档优先工作流程

#### 阶段 1：记录现有系统

**最佳方法 - 具有 100万+ 上下文的 Gemini Web**：

1. **前往 Gemini Web** (gemini.google.com)
2. **上传您的项目**：
   - **选项 A**：直接粘贴您的 GitHub 仓库 URL
   - **选项 B**：上传您的 flattened-codebase.xml 文件
3. **加载分析师代理**：上传 `dist/agents/architect.txt`
4. **运行文档记录**：输入 `*document-project`

分析师将生成所有内容的全面文档。

#### 阶段 2：规划您的增强内容

##### 选项 A：完整棕地工作流程（推荐用于重大更改）

**1. 创建棕地 PRD**：

```bash
@pm
*create-brownfield-prd
```

PM 代理将会：

- **分析第 1 阶段的现有文档**
- **向您请求具体的增强细节**
- **评估复杂性**并推荐方法
- **为增强内容创建史诗/故事结构**
- **识别风险和集成点**

**PM 代理如何获取项目上下文**：

- 在 Gemini Web 中：从第 1 阶段文档中已拥有完整项目上下文
- 在 IDE 中：将询问"请提供您现有项目文档的路径"

**您将遇到的关键提示**：

- "您想要添加什么具体的增强或功能？"
- "这需要与哪些现有系统或 API 集成？"
- "我们必须遵守哪些关键约束？"
- "您的时间表和团队规模是什么？"

**2. 创建棕地架构**：

```bash
@architect
*create-brownfield-architecture
```

架构师将会：

- **审查棕地 PRD**
- **设计集成策略**
- **规划迁移方法**（如果需要）
- **识别技术风险**
- **定义兼容性要求**

##### 选项 B：快速增强（用于专注的更改）

**用于没有完整 PRD 的单个史诗**：

```bash
@pm
*create-brownfield-epic
```

在以下情况下使用：

- 增强内容定义明确且独立
- 现有文档全面
- 更改不影响多个系统
- 您需要快速周转

**用于单个故事**：

```bash
@pm
*create-brownfield-story
```

在以下情况下使用：

- Bug 修复或微小功能
- 非常独立的更改
- 无架构影响
- 明确的实现路径

### 阶段 3：验证规划工件

```bash
@po
*execute-checklist-po
```

PO 确保：

- 与现有系统的兼容性
- 未计划破坏性更改
- 风险缓解策略已就位
- 明确的集成方法

### 阶段 4：保存和分片文档

1. 将您的 PRD 和架构保存为：
   docs/brownfield-prd.md
   docs/brownfield-architecture.md
2. 分片您的文档：
   在您的 IDE 中

   ```bash
   @po
   shard docs/brownfield-prd.md
   ```

   ```bash
   @po
   shard docs/brownfield-architecture.md
   ```

### 阶段 5：过渡到开发

**遵循[<ins>增强型 IDE 开发工作流程</ins>](enhanced-ide-development-workflow.md)**

## 棕地开发最佳实践

### 1. 始终首先记录文档

即使您认为自己了解代码库：

- 运行 `document-project` 以捕获当前状态
- AI 代理需要此上下文
- 发现未记录的模式

### 2. 尊重现有模式

棕地模板专门寻找：

- 当前的编码约定
- 现有的架构模式
- 技术约束
- 团队偏好

### 3. 规划逐步推出

棕地更改应该：

- 支持功能标志
- 规划回滚策略
- 包含迁移脚本
- 保持向后兼容性

### 4. 彻底测试集成

专注于测试：

- 集成点
- 现有功能（回归）
- 性能影响
- 数据迁移

### 5. 沟通更改

记录：

- 更改了什么以及为什么
- 迁移说明
- 引入的新模式
- 弃用通知

## 常见棕地场景

### 场景 1：添加新功能

1. 记录现有系统
2. 创建专注于集成的棕地 PRD
3. 架构强调兼容性
4. 故事包含集成任务

### 场景 2：现代化遗留代码

1. 广泛的文档记录阶段
2. PRD 包含迁移策略
3. 架构规划逐步过渡
4. 故事遵循绞杀者无花果模式

### 场景 3：复杂系统中的 Bug 修复

1. 记录相关子系统
2. 使用 `create-brownfield-story` 进行专注修复
3. 包含回归测试要求
4. QA 验证无副作用

### 场景 4：API 集成

1. 记录现有 API 模式
2. PRD 定义集成要求
3. 架构确保一致的模式
4. 故事包含 API 文档更新

## 故障排除

### "AI 不理解我的代码库"

**解决方案**：使用更具体的路径重新运行 `document-project` 到关键文件

### "生成的计划不适合我们的模式"

**解决方案**：在规划阶段之前用您的特定约定更新生成的文档

### "小更改的样板代码太多"

**解决方案**：使用 `create-brownfield-story` 而不是完整工作流程

### "集成点不明确"

**解决方案**：在 PRD 创建期间提供更多上下文，特别突出集成系统

## 快速参考

### 棕地特定命令

```bash
# 记录现有项目
@architect → *document-project

# 创建增强 PRD
@pm → *create-brownfield-prd

# 创建专注于集成的架构
@architect → *create-brownfield-architecture

# 快速史诗创建
@pm → *create-brownfield-epic

# 单个故事创建
@pm → *create-brownfield-story
```

### 决策树

```text
您是否有大型代码库或单体仓库？
├─ 是 → PRD 优先方法
│   └─ 创建 PRD → 仅记录受影响区域
└─ 否 → 您是否熟悉该代码库？
    ├─ 是 → PRD 优先方法
    └─ 否 → 文档优先方法

这是影响多个系统的主要增强吗？
├─ 是 → 完整棕地工作流程
└─ 否 → 这是否超过简单的 bug 修复？
    ├─ 是 → brownfield-create-epic
    └─ 否 → brownfield-create-story
```

## 结论

使用 BMad-Method 进行棕地开发在修改现有系统时提供了结构和安全性。关键是通过文档提供全面的上下文，使用考虑集成需求的专业模板，并遵循尊重现有约束同时支持进展的工作流程。

记住：**首先记录文档，仔细规划，安全集成**